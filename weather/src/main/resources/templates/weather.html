<!DOCTYPE HTML>
<html 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>

    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="http://cdn.jsdelivr.net/webjars/jquery/3.2.1/jquery.js"
        th:src="@{/webjars/jQuery/jquery.min.js}" type="text/javascript"></script>

    <script th:src="@{webjars/moment/moment.min.js}" type="text/javascript"/>

    <script type="text/javascript">
/* <![CDATA[ */
      function timer() {
        for (var key in functionList) {
          var callable=functionList[key];
          callable.counter--;
        }
        callTimerCallbacks();
      }

      function callTimerCallbacks() {
        console.log("callTimerCallbacks "+document[hidden]);
        if (!document[hidden]) {
          for (var key in functionList) {
            var callable=functionList[key];
            if (callable.counter<=0) {
              callable.function();
              callable.counter=callable.interval;
            }
          }
        }
      }

      // Set the name of the hidden property and the change event for visibility
      var hidden, visibilityChange; 
      if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support 
        hidden = "hidden";
        visibilityChange = "visibilitychange";
      } else if (typeof document.msHidden !== "undefined") {
        hidden = "msHidden";
        visibilityChange = "msvisibilitychange";
      } else if (typeof document.webkitHidden !== "undefined") {
        hidden = "webkitHidden";
        visibilityChange = "webkitvisibilitychange";
      }
 
//var videoElement = document.getElementById("videoElement");

// If the page is hidden, pause the video;
// if the page is shown, play the video
//function handleVisibilityChange() {
//  if (document[hidden]) {
//    videoElement.pause();
//  } else {
//    videoElement.play();
//  }
//}

      // Warn if the browser doesn't support addEventListener or the Page Visibility API
      if (typeof document.addEventListener === "undefined" || typeof document[hidden] === "undefined") {
        console.log("This demo requires a browser, such as Google Chrome or Firefox, that supports the Page Visibility API.");
      } else {
        // Handle page visibility change   
        document.addEventListener(visibilityChange, callTimerCallbacks, false);
      }
    
  // When the video pauses, set the title.
  // This shows the paused
//  videoElement.addEventListener("pause", function(){
//    document.title = 'Paused';
//  }, false);
    
  // When the video plays, set the title.
//  videoElement.addEventListener("play", function(){
//    document.title = 'Playing'; 
//  }, false);

//}
      var functionList=[];
      
      function addFunction(func,interval) {
        var callable={};
        callable.function=func;
        callable.interval=interval;
        callable.counter=interval;
        functionList.push(callable);
      }
            
      var mainTimer = setInterval(timer, 60000);

/* ]]> */
    </script>

    <title>Sää, Rauma, Lappi</title>
    <link rel="stylesheet" href="/main.css"/>
</head>
<body>

  <header>
    <script th:if="${analId!=null}" th:inline="javascript" th:include="fragments/analytics :: googleAnalytics">
    </script>

  
    <div class="site center" th:if="${site!=null}" th:inline="text">
        [[${site}]]
    </div>

    <h1>
        Sääasema Rauma, Lappi, Kivikylä
    </h1>

    <div th:replace="fragments/messages :: currentMessages">
      Viestit
    </div>

    <script type="text/javascript">
/* <![CDATA[ */
  
      function updateWeather() {

          var jsonData = $.ajax({
//          url: "http://localhost:8080/chartdata?id=1&id=6&id=7&fromDate=20160101&toDate=20161231",
          url: "/weatherdata",
          dataType: "json",
          async: false
          }).responseText;
     
        var obj = JSON.parse(jsonData);
//        var rows=obj.rows
        console.log(JSON.stringify(jsonData));

        for (var key in obj) {
          if (obj.hasOwnProperty(key)) {
            console.log(key+" -> " +obj[key]);
            var element=document.getElementById(key);
            if (element!=null) {
              element.innerHTML=obj[key].toFixed(1);
            }
          }
        }
        document.getElementById("updateTime").innerHTML = obj["time"];
        if (obj["windDirection"]!=null && obj["windSpeed"]>0.1) {
          document.getElementById("windDirection").src="/wind_dir/arrow_" + obj["windDirection"].toFixed(0) + ".png";
        }
      }
      
      addFunction(updateWeather,1);
/* ]]> */
    </script>
    
        <button onclick="updateWeather()">Update weather</button>
    
  </header>

    
  <div class="body">

    <main class="content center">
      <div class="page-updated">
        <span>Sivu päivitetty:</span>
        <span id="updateTime" class="no-wrap" th:text="*{weatherdata.time != null} ? ${#temporals.format(weatherdata.time, 'dd.MM.yyyy HH:mm')} : ''">1.1.2017 12:00</span>
      </div>
      <div class="container">
        <div>
          <div th:replace="fragments/basicWeatherData :: basicTemperature">
            Temperature data
          </div>
          <div th:replace="fragments/basicWeatherData :: basicRain">
            Rain data
          </div>
        </div>
        <div th:replace="fragments/graph :: graphTemp">
        </div>
      </div>
    
      <div class="container">
        <div th:replace="fragments/basicWeatherData :: basicWind">
          Wind data
        </div>
        <div th:replace="fragments/graph :: graphWind">
        </div>
      </div>
    </main>

    <nav class="nav" >
      <div th:replace="fragments/menu :: leftMenu">
        Menu
      </div>

      <div th:replace="fragments/news :: lastNews">
        Uutiset:
      </div>
    </nav>

  </div>

  <footer th:replace="fragments/footer :: footer">
    footer
  </footer>


</body>
</html>
